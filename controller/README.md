# Controller

API контроллера асинхронно принимает метки от сенсоров на эндпоинте
**/marks**.

Outdated метки фильтруются, а оставшиеся поступают в канал **marks**
в Redis.

Канал прослушивает скрипт **controller.py**. Он накапливает метки
в течении 5 секунд, формирует на основе накопленных меток
управляющий сигнал и отправляет его манипулятору.

Алгоритм формирования управляющего сигнала следующий:
1. Найдем средний **payload** накопленных меток.
2. Если он больше среднего **payload** меток предыдущего сигнала,
   то отправляем статус _up_, иначе статус _down_.

Управляющий сигнал записывается в PostgreSQL и дата последнего сигнала
кешируется в Redis (нужно для сокращения запросов в БД при
фильтрации меток), если отправка сигнала манипулятору прошла успешно.

Администратор с помощью API может получить последние **n** команд
с помощью эндпоинта **/commands**.

API описан подробнее в формате openapi по эндпоинту **/docs**
(можно визуально протестировать).

# Переменные среды

Переменные среды помещаются в файл **.env**

### ADMIN_API_KEY

Пароль администратора (посылается в заголовке API-Key для получения
команд).

### MANIPULATOR_HOST

Хост манипулятора

### MANIPULATOR_PORT

Порт манипулятора

### REDIS_URL

Адрес подключения к Redis.

### DB_HOST

Хост для подключения к БД

### DB_PORT

Порт для подключения к БД

### DB_USER

Пользователь БД

### DB_PASSWORD

Пароль пользователя БД

### DB_NAME

Имя БД

## Запуск в Docker-compose

Убедитесь, что манипулятор доступен для контейнеров
по адресу **MANIPULATOR_HOST:MANIPULATOR_PORT**

Собрать образы:
```commandline
docker-compose build
```

Запустить контейнеры:
```commandline
docker-compose up -d
```

Остановить контейнеры:
```commandline
docker-compose down
```

Посмотреть логи определенного контейнера:
```commandline
docker logs <container-hash>
```
